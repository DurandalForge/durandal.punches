/*
 Knockout.Punches
 Enhanced binding syntaxes for Knockout 3+
 (c) Michael Best
 License: MIT (http://www.opensource.org/licenses/mit-license.php)
 Version 0.3.0
*/
(function(c){"function"===typeof define&&define.amd?define(["knockout"],c):c(ko)})(function(c){function p(a,b){return v(D(a),"preprocess",b)}function D(a){return"object"===typeof a?a:c.getBindingHandler(a)||(c.bindingHandlers[a]={})}function v(a,b,d){if(a[b]){var g=a[b];a[b]=function(a,b,c){if(a=g.call(this,a,b,c))return d.call(this,a,b,c)}}else a[b]=d;return a}function w(a){var b=c.bindingProvider.instance;if(b.preprocessNode){var d=b.preprocessNode;b.preprocessNode=function(b){var c=d.call(this,
b);c||(c=a.call(this,b));return c}}else b.preprocessNode=a}function E(a,b){var d=c.getBindingHandler;c.getBindingHandler=function(g){var c;return d(g)||(c=g.match(a))&&b(c,g)}}function x(a){if(-1===a.indexOf("|"))return a;var b=a.match(/"([^"\\]|\\.)*"|'([^'\\]|\\.)*'|\|\||[|:]|[^\s|:"'][^|:"']*[^\s|:"']|[^\s|:"']/g);if(b&&1<b.length){b.push("|");a=b[0];for(var d,c,e=!1,f=!1,h=1;c=b[h];++h)"|"===c?(e&&(":"===d&&(a+="undefined"),a+=")"),e=f=!0):(f?a="ko.filters['"+c+"']("+a:e&&":"===c?(":"===d&&(a+=
"undefined"),a+=","):a+=c,f=!1),d=c}return a}function y(a){p(a,x)}function z(a,b,d){function g(d){e[d]&&(e[d]=function(g,e){var F=Array.prototype.slice.call(arguments,0);F[1]=function(){var b={};b[a]=e();return b};return c.bindingHandlers[b][d].apply(this,F)})}var e=c.utils.extend({},this);g("init");g("update");e.preprocess&&(e.preprocess=null);c.virtualElements.allowedBindings[b]&&(c.virtualElements.allowedBindings[d]=!0);return e}function A(a,b){var d=c.getBindingHandler(a);if(d){var g=d.getNamespacedHandler||
z;d.getNamespacedHandler=function(){return p(g.apply(this,arguments),b)}}}function G(a,b,d){if("{"!==a.charAt(0))return a;a=c.expressionRewriting.parseObjectLiteral(a);c.utils.arrayForEach(a,function(a){d(b+H+a.key,a.value)})}function r(a){p(a,G)}function q(a){return/^([$_a-z][$\w]*|.+(\.\s*[$_a-z][$\w]*|\[.+\]))$/i.test(a)?"function(_x,_y,_z){return("+a+")(_x,_y,_z);}":a}function s(a){p(a,q)}function t(a,b,d){a=D(a);a._propertyPreprocessors||(v(a,"preprocess",P),a._propertyPreprocessors={});v(a._propertyPreprocessors,
b,d)}function P(a,b,d){if("{"!==a.charAt(0))return a;a=c.expressionRewriting.parseObjectLiteral(a);var g=[],e=this._propertyPreprocessors||{};c.utils.arrayForEach(a,function(a){var b=a.key;a=a.value;e[b]&&(a=e[b](a,b,d));a&&g.push("'"+b+"':"+a)});return"{"+g.join(",")+"}"}function B(a){return function(b){return"function("+a+"){return("+b+");}"}}function I(a,b,d){function c(a){var f=a.match(/^([\s\S]*)}}([\s\S]*?)\{\{([\s\S]*)$/);f?(c(f[1]),b(f[2]),d(f[3])):d(a)}if(a=a.match(/^([\s\S]*?)\{\{([\s\S]*)}}([\s\S]*)$/))b(a[1]),
c(a[2]),b(a[3])}function C(a){return null==a?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")}function J(){w(K.preprocessor)}function L(a,b,d){return c.getBindingHandler(a)?a+":"+b:"attr."+a+":"+b}function M(){w(N.preprocessor)}function C(a){return null==a?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")}var m=c.punches={utils:{setBindingPreprocessor:p,setNodePreprocessor:w,setBindingHandlerCreator:E}};m.enableAll=function(){J();M();r("attr");r("css");r("event");
r("style");y("text");y("html");A("attr",x);s("click");s("submit");s("optionsAfterRender");A("event",q);t("template","beforeRemove",q);t("template","afterAdd",q);t("template","afterRender",q)};c.filters={uppercase:function(a){return String.prototype.toUpperCase.call(a)},lowercase:function(a){return String.prototype.toLowerCase.call(a)},"default":function(a,b){return""===a||null==a?b:a},replace:function(a,b,d){return String.prototype.replace.call(a,b,d)},fit:function(a,b,d,c){if(b&&(""+a).length>b)switch(d=
""+(d||"..."),b-=d.length,a=""+a,c){case "left":return d+a.slice(-b);case "middle":return c=Math.ceil(b/2),a.substr(0,c)+d+a.slice(c-b);default:return a.substr(0,b)+d}else return a},json:function(a,b,d){return c.toJSON(a,d,b)},number:function(a){return(+a).toLocaleString()}};m.textFilter={preprocessor:x,enableForBinding:y};var H=".";E(/([^\.]+)\.(.+)/,function(a,b){var d=a[1],g=c.bindingHandlers[d];if(g)return d=(g.getNamespacedHandler||z).call(g,a[2],d,b),c.bindingHandlers[b]=d});m.namespacedBinding=
{defaultGetHandler:z,setDefaultBindingPreprocessor:A,preprocessor:G,enableForBinding:r};m.wrappedCallback={preprocessor:q,enableForBinding:s};m.preprocessBindingProperty={setPreprocessor:t};var O=B("$data,$event");m.expressionCallback={makePreprocessor:B,eventPreprocessor:O,enableForBinding:function(a,b){b=Array.prototype.slice.call(arguments,1).join();p(a,B(b))}};c.bindingHandlers.on={getNamespacedHandler:function(a){a=c.getBindingHandler("event"+H+a);return p(a,O)}};if(!c.virtualElements.allowedBindings.html){var Q=
c.bindingHandlers.html.update;c.bindingHandlers.html.update=function(a,b){if(8===a.nodeType){var d=c.utils.unwrapObservable(b());null!=d?(d=c.utils.parseHtmlFragment(""+d),c.virtualElements.setDomNodeChildren(a,d)):c.virtualElements.emptyNode(a)}else Q(a,b)};c.virtualElements.allowedBindings.html=!0}var K=m.interpolationMarkup={preprocessor:function(a){if(3===a.nodeType&&a.nodeValue&&-1!==a.nodeValue.indexOf("{{")){var b=[];I(a.nodeValue,function(a){a&&b.push(document.createTextNode(a))},function(d){d&&
b.push.apply(b,K.wrapExpression(C(d),a))});if(b.length){if(a.parentNode){for(var d=0,c=b.length,e=a.parentNode;d<c;++d)e.insertBefore(b[d],a);e.removeChild(a)}return b}}},enable:J,wrapExpression:function(a,b){var d=b?b.ownerDocument:document,c=d.createComment("/ko"),e=a[0];return"#"===e?[d.createComment("ko "+a.slice(1))]:"/"===e?[c]:"{"===e&&"}"===a[a.length-1]?[d.createComment("ko html:"+a.slice(1,-1)),c]:[d.createComment("ko text:"+a),c]}},n="data-bind",N=m.attributeInterpolationMarkup={preprocessor:function(a){if(1===
a.nodeType&&a.attributes.length)for(var b=a.getAttribute(n),d=a.attributes,c=d.length-1;0<=c;--c){var e=d[c];if(e.specified&&e.name!=n&&-1!==e.value.indexOf("{{")){var f=[],h="";I(e.value,function(a){a&&f.push('"'+a.replace(/"/g,'\\"')+'"')},function(a){a&&(h=a,f.push("ko.unwrap("+a+")"))});1<f.length&&(h='""+'+f.join("+"));if(h){var k=N.attributeBinding(e.name,h,a)||L(e.name,h,a),b=b?b+(","+k):k;a.setAttribute(n,b);a.removeAttributeNode(e)}}}},enable:M,attributeBinding:L},l={},u=null,R=c.punches.attributeInterpolationMarkup.attributeBinding;
l.attributeBinding=function(a,b,d){return"value"==a?"value:"+b+", valueUpdate: 'keyup'":R(a,b,d)};var S=c.punches.interpolationMarkup.wrapExpression;l.wrapExpression=function(a,b){var d=b?b.ownerDocument:document,c=d.createComment("/ko"),e=a[0];if("else"==a&&u)return[c,d.createComment("ko ifnot:"+u)];var f=[["each","foreach"],["with","with"],["if","if"]];if("#"===e)for(var h=0;h<f.length;h++){var k=f[h][0],l=f[h][1];if(0===a.indexOf(e+k))return a=a.replace(e+k,""),a=C(a),"if"==k&&(u=a),[d.createComment("ko "+
l+":"+a)];if(0===a.indexOf("/"+k))return"if"==k&&(u=null),[c]}return S(a,b)};var T=c.punches.attributeInterpolationMarkup.preprocessor,n="data-bind";l.attributePreprocessor=function(a){if(1===a.nodeType&&a.attributes.length){for(var b=a.getAttribute(n),d=[],g=a.attributes,e=g.length-1;0<=e;--e){var f=g[e];if(f.specified&&f.name!=n){var h=f.name.match(/^on-(.+)/),k=f.name.match(/^bind-(.+)/);h?(d.push(h[1]+": function(){ "+f.value+" }"),a.removeAttributeNode(f)):k&&(h=f.value,k=k[1],h&&(k=c.punches.attributeInterpolationMarkup.attributeBinding(k,
h,a)||l.attributeBinding(k,h,a),b=b?b+(","+k):k,a.setAttribute(n,b),a.removeAttributeNode(f)))}}d.length&&(d="event: {"+d.join(", ")+"}",a.setAttribute(n,b?b+(","+d):d));return T(a)}};var U=c.punches.interpolationMarkup.preprocessor;l.interpolationPreprocessor=function(a){if("view-port"==a.localName||"router-view-port"==a.localName){var b=document.createElement("div");b.setAttribute("data-bind","router: {cacheViews: true, transition: 'entrance'}");a.parentNode&&(a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a));
return[b]}return U(a)};c.punches.interpolationMarkup.wrapExpression=l.wrapExpression;c.punches.attributeInterpolationMarkup.attributeBinding=l.attributeBinding;c.punches.attributeInterpolationMarkup.preprocessor=l.attributePreprocessor;c.punches.interpolationMarkup.preprocessor=l.interpolationPreprocessor});
