/*
 Knockout.Punches
 Enhanced binding syntaxes for Knockout 3+
 (c) Michael Best
 License: MIT (http://www.opensource.org/licenses/mit-license.php)
 Version 0.3.0
*/
(function(d){"function"===typeof define&&define.amd?define(["knockout"],d):d(ko)})(function(d){function h(a,b){return q(y(a),"preprocess",b)}function y(a){return"object"===typeof a?a:d.getBindingHandler(a)||(d.bindingHandlers[a]={})}function q(a,b,c){if(a[b]){var f=a[b];a[b]=function(a,b,d){if(a=f.call(this,a,b,d))return c.call(this,a,b,d)}}else a[b]=c;return a}function r(a){var b=d.bindingProvider.instance;if(b.preprocessNode){var c=b.preprocessNode;b.preprocessNode=function(b){var e=c.call(this,
b);e||(e=a.call(this,b));return e}}else b.preprocessNode=a}function z(a,b){var c=d.getBindingHandler;d.getBindingHandler=function(f){var e;return c(f)||(e=f.match(a))&&b(e,f)}}function s(a){if(-1===a.indexOf("|"))return a;var b=a.match(/"([^"\\]|\\.)*"|'([^'\\]|\\.)*'|\|\||[|:]|[^\s|:"'][^|:"']*[^\s|:"']|[^\s|:"']/g);if(b&&1<b.length){b.push("|");a=b[0];for(var c,f,e=!1,d=!1,k=1;f=b[k];++k)"|"===f?(e&&(":"===c&&(a+="undefined"),a+=")"),e=d=!0):(d?a="ko.filters['"+f+"']("+a:e&&":"===f?(":"===c&&(a+=
"undefined"),a+=","):a+=f,d=!1),c=f}return a}function t(a){h(a,s)}function u(a,b,c){function f(c){e[c]&&(e[c]=function(f,e){var A=Array.prototype.slice.call(arguments,0);A[1]=function(){var b={};b[a]=e();return b};return d.bindingHandlers[b][c].apply(this,A)})}var e=d.utils.extend({},this);f("init");f("update");e.preprocess&&(e.preprocess=null);d.virtualElements.allowedBindings[b]&&(d.virtualElements.allowedBindings[c]=!0);return e}function v(a,b){var c=d.getBindingHandler(a);if(c){var f=c.getNamespacedHandler||
u;c.getNamespacedHandler=function(){return h(f.apply(this,arguments),b)}}}function B(a,b,c){if("{"!==a.charAt(0))return a;a=d.expressionRewriting.parseObjectLiteral(a);d.utils.arrayForEach(a,function(a){c(b+C+a.key,a.value)})}function m(a){h(a,B)}function l(a){return/^([$_a-z][$\w]*|.+(\.\s*[$_a-z][$\w]*|\[.+\]))$/i.test(a)?"function(_x,_y,_z){return("+a+")(_x,_y,_z);}":a}function n(a){h(a,l)}function p(a,b,c){a=y(a);a._propertyPreprocessors||(q(a,"preprocess",K),a._propertyPreprocessors={});q(a._propertyPreprocessors,
b,c)}function K(a,b,c){if("{"!==a.charAt(0))return a;a=d.expressionRewriting.parseObjectLiteral(a);var f=[],e=this._propertyPreprocessors||{};d.utils.arrayForEach(a,function(a){var b=a.key;a=a.value;e[b]&&(a=e[b](a,b,c));a&&f.push("'"+b+"':"+a)});return"{"+f.join(",")+"}"}function w(a){return function(b){return"function("+a+"){return("+b+");}"}}function D(a,b,c){function f(a){var d=a.match(/^([\s\S]*)}}([\s\S]*?)\{\{([\s\S]*)$/);d?(f(d[1]),b(d[2]),c(d[3])):c(a)}if(a=a.match(/^([\s\S]*?)\{\{([\s\S]*)}}([\s\S]*)$/))b(a[1]),
f(a[2]),b(a[3])}function E(a){if(3===a.nodeType&&a.nodeValue&&-1!==a.nodeValue.indexOf("{{")){var b=[];D(a.nodeValue,function(a){a&&b.push(document.createTextNode(a))},function(c){c&&b.push.apply(b,L.wrapExpression(null==c?"":c.trim?c.trim():c.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,""),a))});if(b.length){if(a.parentNode){for(var c=0,d=b.length,e=a.parentNode;c<d;++c)e.insertBefore(b[c],a);e.removeChild(a)}return b}}}function F(){r(E)}function G(a){if(1===a.nodeType&&a.attributes.length)for(var b=
a.getAttribute(x),c=a.attributes,d=c.length-1;0<=d;--d){var e=c[d];if(e.specified&&e.name!=x&&-1!==e.value.indexOf("{{")){var g=[],k="";D(e.value,function(a){a&&g.push('"'+a.replace(/"/g,'\\"')+'"')},function(a){a&&(k=a,g.push("ko.unwrap("+a+")"))});1<g.length&&(k='""+'+g.join("+"));if(k){var h=M.attributeBinding(e.name,k,a)||H(e.name,k,a),b=b?b+(","+h):h;a.setAttribute(x,b);a.removeAttributeNode(e)}}}}function H(a,b,c){return d.getBindingHandler(a)?a+":"+b:"attr."+a+":"+b}function I(){r(G)}var g=
d.punches={utils:{setBindingPreprocessor:h,setNodePreprocessor:r,setBindingHandlerCreator:z}};g.enableAll=function(){F();I();m("attr");m("css");m("event");m("style");t("text");t("html");v("attr",s);n("click");n("submit");n("optionsAfterRender");v("event",l);p("template","beforeRemove",l);p("template","afterAdd",l);p("template","afterRender",l)};d.filters={uppercase:function(a){return String.prototype.toUpperCase.call(a)},lowercase:function(a){return String.prototype.toLowerCase.call(a)},"default":function(a,
b){return""===a||null==a?b:a},replace:function(a,b,c){return String.prototype.replace.call(a,b,c)},fit:function(a,b,c,d){if(b&&(""+a).length>b)switch(c=""+(c||"..."),b-=c.length,a=""+a,d){case "left":return c+a.slice(-b);case "middle":return d=Math.ceil(b/2),a.substr(0,d)+c+a.slice(d-b);default:return a.substr(0,b)+c}else return a},json:function(a,b,c){return d.toJSON(a,c,b)},number:function(a){return(+a).toLocaleString()}};g.textFilter={preprocessor:s,enableForBinding:t};var C=".";z(/([^\.]+)\.(.+)/,
function(a,b){var c=a[1],f=d.bindingHandlers[c];if(f)return c=(f.getNamespacedHandler||u).call(f,a[2],c,b),d.bindingHandlers[b]=c});g.namespacedBinding={defaultGetHandler:u,setDefaultBindingPreprocessor:v,preprocessor:B,enableForBinding:m};g.wrappedCallback={preprocessor:l,enableForBinding:n};g.preprocessBindingProperty={setPreprocessor:p};var J=w("$data,$event");g.expressionCallback={makePreprocessor:w,eventPreprocessor:J,enableForBinding:function(a,b){b=Array.prototype.slice.call(arguments,1).join();
h(a,w(b))}};d.bindingHandlers.on={getNamespacedHandler:function(a){a=d.getBindingHandler("event"+C+a);return h(a,J)}};if(!d.virtualElements.allowedBindings.html){var N=d.bindingHandlers.html.update;d.bindingHandlers.html.update=function(a,b){if(8===a.nodeType){var c=d.utils.unwrapObservable(b());null!=c?(c=d.utils.parseHtmlFragment(""+c),d.virtualElements.setDomNodeChildren(a,c)):d.virtualElements.emptyNode(a)}else N(a,b)};d.virtualElements.allowedBindings.html=!0}var L=g.interpolationMarkup={preprocessor:E,
enable:F,wrapExpression:function(a,b){var c=b?b.ownerDocument:document,d=c.createComment("/ko"),e=a[0];return"#"===e?[c.createComment("ko "+a.slice(1))]:"/"===e?[d]:"{"===e&&"}"===a[a.length-1]?[c.createComment("ko html:"+a.slice(1,-1)),d]:[c.createComment("ko text:"+a),d]}},x="data-bind",M=g.attributeInterpolationMarkup={preprocessor:G,enable:I,attributeBinding:H}});
