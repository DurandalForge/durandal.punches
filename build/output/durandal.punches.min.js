/*
 Knockout.Punches
 Enhanced binding syntaxes for Knockout 3+
 (c) Michael Best
 License: MIT (http://www.opensource.org/licenses/mit-license.php)
 Version 0.3.0
*/
(function(d){"function"===typeof define&&define.amd?define(["knockout"],d):d(ko)})(function(d){function p(a,b){return v(D(a),"preprocess",b)}function D(a){return"object"===typeof a?a:d.getBindingHandler(a)||(d.bindingHandlers[a]={})}function v(a,b,c){if(a[b]){var f=a[b];a[b]=function(a,b,g){if(a=f.call(this,a,b,g))return c.call(this,a,b,g)}}else a[b]=c;return a}function w(a){var b=d.bindingProvider.instance;if(b.preprocessNode){var c=b.preprocessNode;b.preprocessNode=function(b){var e=c.call(this,
b);e||(e=a.call(this,b));return e}}else b.preprocessNode=a}function E(a,b){var c=d.getBindingHandler;d.getBindingHandler=function(f){var e;return c(f)||(e=f.match(a))&&b(e,f)}}function x(a){if(-1===a.indexOf("|"))return a;var b=a.match(/"([^"\\]|\\.)*"|'([^'\\]|\\.)*'|\|\||[|:]|[^\s|:"'][^|:"']*[^\s|:"']|[^\s|:"']/g);if(b&&1<b.length){b.push("|");a=b[0];for(var c,f,e=!1,k=!1,g=1;f=b[g];++g)"|"===f?(e&&(":"===c&&(a+="undefined"),a+=")"),e=k=!0):(k?a="ko.filters['"+f+"']("+a:e&&":"===f?(":"===c&&(a+=
"undefined"),a+=","):a+=f,k=!1),c=f}return a}function y(a){p(a,x)}function z(a,b,c){function f(c){e[c]&&(e[c]=function(f,e){var F=Array.prototype.slice.call(arguments,0);F[1]=function(){var b={};b[a]=e();return b};return d.bindingHandlers[b][c].apply(this,F)})}var e=d.utils.extend({},this);f("init");f("update");e.preprocess&&(e.preprocess=null);d.virtualElements.allowedBindings[b]&&(d.virtualElements.allowedBindings[c]=!0);return e}function A(a,b){var c=d.getBindingHandler(a);if(c){var f=c.getNamespacedHandler||
z;c.getNamespacedHandler=function(){return p(f.apply(this,arguments),b)}}}function G(a,b,c){if("{"!==a.charAt(0))return a;a=d.expressionRewriting.parseObjectLiteral(a);d.utils.arrayForEach(a,function(a){c(b+H+a.key,a.value)})}function r(a){p(a,G)}function q(a){return/^([$_a-z][$\w]*|.+(\.\s*[$_a-z][$\w]*|\[.+\]))$/i.test(a)?"function(_x,_y,_z){return("+a+")(_x,_y,_z);}":a}function s(a){p(a,q)}function t(a,b,c){a=D(a);a._propertyPreprocessors||(v(a,"preprocess",P),a._propertyPreprocessors={});v(a._propertyPreprocessors,
b,c)}function P(a,b,c){if("{"!==a.charAt(0))return a;a=d.expressionRewriting.parseObjectLiteral(a);var f=[],e=this._propertyPreprocessors||{};d.utils.arrayForEach(a,function(a){var b=a.key;a=a.value;e[b]&&(a=e[b](a,b,c));a&&f.push("'"+b+"':"+a)});return"{"+f.join(",")+"}"}function B(a){return function(b){return"function("+a+"){return("+b+");}"}}function I(a,b,c){function f(a){var e=a.match(/^([\s\S]*)}}([\s\S]*?)\{\{([\s\S]*)$/);e||(e=a.match(/^([\s\S]*)}([\s\S]*?)\$\{([\s\S]*)$/));e?(f(e[1]),b(e[2]),
c(e[3])):c(a)}var e=a.match(/^([\s\S]*?)\{\{([\s\S]*)}}([\s\S]*)$/);e||(e=a.match(/^([\s\S]*?)\$\{([\s\S]*)}([\s\S]*)$/));e&&(b(e[1]),f(e[2]),b(e[3]))}function C(a){return null==a?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")}function J(){w(K.preprocessor)}function L(a,b,c){return d.getBindingHandler(a)?a+":"+b:"attr."+a+":"+b}function M(){w(N.preprocessor)}function C(a){return null==a?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")}var m=d.punches={utils:{setBindingPreprocessor:p,
setNodePreprocessor:w,setBindingHandlerCreator:E}};m.enableAll=function(){J();M();r("attr");r("css");r("event");r("style");y("text");y("html");A("attr",x);s("click");s("submit");s("optionsAfterRender");A("event",q);t("template","beforeRemove",q);t("template","afterAdd",q);t("template","afterRender",q)};d.filters={uppercase:function(a){return String.prototype.toUpperCase.call(a)},lowercase:function(a){return String.prototype.toLowerCase.call(a)},"default":function(a,b){return""===a||null==a?b:a},replace:function(a,
b,c){return String.prototype.replace.call(a,b,c)},fit:function(a,b,c,f){if(b&&(""+a).length>b)switch(c=""+(c||"..."),b-=c.length,a=""+a,f){case "left":return c+a.slice(-b);case "middle":return f=Math.ceil(b/2),a.substr(0,f)+c+a.slice(f-b);default:return a.substr(0,b)+c}else return a},json:function(a,b,c){return d.toJSON(a,c,b)},number:function(a){return(+a).toLocaleString()}};m.textFilter={preprocessor:x,enableForBinding:y};var H=".";E(/([^\.]+)\.(.+)/,function(a,b){var c=a[1],f=d.bindingHandlers[c];
if(f)return c=(f.getNamespacedHandler||z).call(f,a[2],c,b),d.bindingHandlers[b]=c});m.namespacedBinding={defaultGetHandler:z,setDefaultBindingPreprocessor:A,preprocessor:G,enableForBinding:r};m.wrappedCallback={preprocessor:q,enableForBinding:s};m.preprocessBindingProperty={setPreprocessor:t};var O=B("$data,$event");m.expressionCallback={makePreprocessor:B,eventPreprocessor:O,enableForBinding:function(a,b){b=Array.prototype.slice.call(arguments,1).join();p(a,B(b))}};d.bindingHandlers.on={getNamespacedHandler:function(a){a=
d.getBindingHandler("event"+H+a);return p(a,O)}};if(!d.virtualElements.allowedBindings.html){var Q=d.bindingHandlers.html.update;d.bindingHandlers.html.update=function(a,b){if(8===a.nodeType){var c=d.utils.unwrapObservable(b());null!=c?(c=d.utils.parseHtmlFragment(""+c),d.virtualElements.setDomNodeChildren(a,c)):d.virtualElements.emptyNode(a)}else Q(a,b)};d.virtualElements.allowedBindings.html=!0}var K=m.interpolationMarkup={preprocessor:function(a){if(3===a.nodeType&&a.nodeValue&&(-1!==a.nodeValue.indexOf("{{")||
-1!==a.nodeValue.indexOf("${"))){var b=[];I(a.nodeValue,function(a){a&&b.push(document.createTextNode(a))},function(c){c&&b.push.apply(b,K.wrapExpression(C(c),a))});if(b.length){if(a.parentNode){for(var c=0,f=b.length,e=a.parentNode;c<f;++c)e.insertBefore(b[c],a);e.removeChild(a)}return b}}},enable:J,wrapExpression:function(a,b){var c=b?b.ownerDocument:document,f=c.createComment("/ko"),e=a[0];return"#"===e?[c.createComment("ko "+a.slice(1))]:"/"===e?[f]:"{"===e&&"}"===a[a.length-1]?[c.createComment("ko html:"+
a.slice(1,-1)),f]:[c.createComment("ko text:"+a),f]}},n="data-bind",N=m.attributeInterpolationMarkup={preprocessor:function(a){if(1===a.nodeType&&a.attributes.length)for(var b=a.getAttribute(n),c=a.attributes,f=c.length-1;0<=f;--f){var e=c[f];if(e.specified&&e.name!=n&&(-1!==e.value.indexOf("{{")||-1!==e.value.indexOf("${"))){var k=[],d="";I(e.value,function(a){a&&k.push('"'+a.replace(/"/g,'\\"')+'"')},function(a){a&&(d=a,k.push("ko.unwrap("+a+")"))});1<k.length&&(d='""+'+k.join("+"));if(d){var h=
N.attributeBinding(e.name,d,a)||L(e.name,d,a),b=b?b+(","+h):h;a.setAttribute(n,b);a.removeAttributeNode(e)}}}},enable:M,attributeBinding:L},l={},u=null,R=d.punches.attributeInterpolationMarkup.attributeBinding;l.attributeBinding=function(a,b,c,f){var e=[];if("value"==a)return"value:"+b+",valueUpdate:'keyup'";if("style"==a)return"attr.style: "+b;if("if"==a||"repeat"==a){a="if"==a;f="row";if(e=b.match(/(.+?)\s+?as\s+?(\w+)/))f=e[2],b=e[1];else if(e=b.match(/(.+?)\s+?of\s+?(.+)/))f=e[1],b=e[2];var d=
c?c.ownerDocument:document,e=d.createComment("/ko");b=d.createComment(a?"ko if:"+b:"ko foreach:{data:"+b+",as:'"+f+"'}");c.parentNode.insertBefore(b,c);c.parentNode.insertBefore(e,c.nextSibling);a||(c.parentNode.insertBefore(d.createComment("ko with:$parent"),c),c.parentNode.insertBefore(d.createComment("/ko"),c.nextSibling));return"TEMPLATE"==c.nodeName?(b=d.createComment("ko with:$data"),e=d.createComment("/ko"),c.parentNode.insertBefore(b,c),c.parentNode.insertBefore(e,c.nextSibling),b=c.content?
document.importNode(c.content,!0):c.children[0],c.parentNode.insertBefore(b,e),c.parentNode.removeChild(c),""):"with:$data"}f&&(a=a.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()}));return-1!==["optionsText","optionsValue","optionsCaption"].indexOf(a)?a+":"+b:R(a,b,c)};var S=d.punches.interpolationMarkup.wrapExpression;l.wrapExpression=function(a,b){var c=b?b.ownerDocument:document,f=c.createComment("/ko"),e=a[0];if("else"==a&&u)return[f,c.createComment("ko ifnot:"+u)];var d=[["each","foreach"],
["with","with"],["if","if"]];if("#"===e)for(var g=0;g<d.length;g++){var h=d[g][0],l=d[g][1];if(0===a.indexOf(e+h))return a=a.replace(e+h,""),a=C(a),"if"==h&&(u=a),[c.createComment("ko "+l+":"+a)];if(0===a.indexOf("/"+h))return"if"==h&&(u=null),[f]}return S(a,b)};var T=d.punches.attributeInterpolationMarkup.preprocessor,n="data-bind";l.attributePreprocessor=function(a){if(1===a.nodeType&&a.attributes.length){for(var b=a.getAttribute(n),c=[],f=a.attributes,e=f.length-1;0<=e;--e){var d=f[e];if(d.specified&&
d.name!=n){var g=d.name.match(/^(.+)\.delegate$/),h=d.name.match(/^(.+)\.bind$/);h||(h=d.name.match(/^bind-(.+)/));h||(h=d.name.match(/^\[(.+?)\]$/));g||(g=d.name.match(/^(.+)\.trigger$/));g||(g=d.name.match(/^on-(.+)/));g||(g=d.name.match(/^\((.+?)\)$/));"repeat.for"==d.name&&(h=["repeat.for","repeat"]);"if"==d.name||"repeat"==d.name||"active"==d.name?a.removeAttributeNode(d):g?(c.push(g[1]+": function($data,$event){ "+d.value+" }"),a.removeAttributeNode(d)):h&&(g=d.value,h=h[1],g&&(h=l.attributeBinding(h,
g,a,!0),b=b?b+(","+h):h,a.setAttribute(n,b),a.removeAttributeNode(d)))}}c.length&&(c="event: {"+c.join(", ")+"}",a.setAttribute(n,b?b+(","+c):c));return T(a)}};var U=d.punches.interpolationMarkup.preprocessor;l.interpolationPreprocessor=function(a){var b;a.localName&&(b=a.localName.toLowerCase().replace(/-([a-z])/g,function(a){return a[1].toUpperCase()}));if(b&&"template"!=b&&d.getBindingHandler(b)){for(var c=[],f,e={},k=0;k<a.attributes.length;k++){var g=a.attributes[k];(f=g.name.match(/^(.+)\.bind$/))||
(f=g.name.match(/^bind-(.+)/));f||(f=g.name.match(/^\[(.+?)\]$/));f?(f=f[1],f=f.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()}),c.push(f+":"+g.nodeValue)):e[g.name]=g.nodeValue}c="{"+c.join(",")+"}";k=document.createElement("div");k.setAttribute("data-bind",b+": "+c);for(var h in e)k.setAttribute(h,e[h]);k.innerHTML=a.innerHTML;a.parentNode&&(a.parentNode.insertBefore(k,a),a.parentNode.removeChild(a));return[k]}return U(a)};d.punches.interpolationMarkup.wrapExpression=l.wrapExpression;
d.punches.attributeInterpolationMarkup.attributeBinding=l.attributeBinding;d.punches.attributeInterpolationMarkup.preprocessor=l.attributePreprocessor;d.punches.interpolationMarkup.preprocessor=l.interpolationPreprocessor});
